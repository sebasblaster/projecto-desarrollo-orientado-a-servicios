{% extends "base.html" %}

{% block title %}Login | Cliente HSRT{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-5 col-lg-4">
    <div class="card border-0 shadow-sm mt-4">
      <div class="card-body p-4">
        <div class="text-center mb-3">
          <div
            class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
            style="width: 52px; height: 52px; background-color: rgba(13,110,253,0.08);"
          >
            <i
              class="bi bi-shield-lock-fill"
              style="font-size: 1.6rem; color: #0d6efd;"
            ></i>
          </div>
          <h1 class="h5 mb-0">Iniciar sesión</h1>
          <p class="text-muted small mb-0">
            Acceso al cliente HSRT – Inventario &amp; Mantenimientos
          </p>
        </div>

        <form id="loginForm" method="post" action="{{ url_for('login') }}">
          <div class="mb-3">
            <label class="form-label small fw-semibold">
              Usuario
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text">
                <i class="bi bi-person-fill"></i>
              </span>
              <input
                type="text"
                name="username"
                class="form-control"
                placeholder="usuario institucional"
                required
              />
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label small fw-semibold">
              Contraseña
            </label>
            <div class="input-group input-group-sm">
              <span class="input-group-text">
                <i class="bi bi-lock-fill"></i>
              </span>
              <input
                type="password"
                name="password"
                class="form-control"
                placeholder="••••••••"
                required
              />
            </div>
          </div>

          {# Campo oculto que llenará reCAPTCHA v3 #}
          <input
            type="hidden"
            name="g-recaptcha-response"
            id="g-recaptcha-response"
          />

          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-box-arrow-in-right me-1"></i>
            Entrar
          </button>

          <div class="mt-2 text-center">
            <small class="text-muted" style="font-size: 0.7rem;">
              This site is protected by reCAPTCHA and the Google
              <a href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer">
                Privacy Policy
              </a>
              and
              <a href="https://policies.google.com/terms" target="_blank" rel="noopener noreferrer">
                Terms of Service
              </a>
              apply.
            </small>
          </div>
        </form>

        <div class="mt-3 text-center">
          <a href="{{ url_for('forgot_password') }}" class="small">
            ¿Olvidaste tu contraseña?
          </a>
        </div>
      </div>
      <div class="card-footer bg-light text-center py-2">
        <small class="text-muted">
          USTA · HSRT · Acceso seguro
        </small>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{# Bloque de scripts específicos para esta vista (login) #}
{% block extra_scripts %}
  {# Script reCAPTCHA v3 con la clave de sitio que se pasa desde Flask #}
  <script src="https://www.google.com/recaptcha/api.js?render={{ RECAPTCHA_SITE_KEY }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('loginForm');
      if (!form) return;

      form.addEventListener('submit', function (e) {
        // Evitamos que el form se envíe inmediatamente
        e.preventDefault();

        grecaptcha.ready(function () {
          grecaptcha.execute('{{ RECAPTCHA_SITE_KEY }}', { action: 'login' })
            .then(function (token) {
              // Colocamos el token en el campo oculto
              const tokenInput = document.getElementById('g-recaptcha-response');
              if (tokenInput) {
                tokenInput.value = token;
              }
              // Ahora sí, enviamos el formulario
              form.submit();
            });
        });
      });
    });
  </script>
{% endblock %}
